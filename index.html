<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>BLR Backend</title>
  <style>
    body{font-family:system-ui,Arial;margin:0;background:#0d1117;color:#e6edf3}
    .wrap{max-width:960px;margin:auto;padding:20px}
    .bar{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:14px}
    .btn{cursor:pointer;border:1px solid #2d3a7b;background:linear-gradient(180deg,#2b47e5,#2038d0);color:#fff;padding:10px 14px;border-radius:10px;font-weight:700}
    .btn.ghost{background:#0f172a;border-color:#2b2f3a}
    .panel{background:#0f131a;border:1px solid #262a36;border-radius:14px;padding:16px;margin:12px 0}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    input,select,textarea{padding:10px;border-radius:10px;border:1px solid #2a2f3d;background:#0b0f16;color:#e6edf3}
    label{font-size:12px;color:#9aa4ae}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px dashed #242838;text-align:left}
    .muted{color:#9aa4ae}
    .hidden{display:none}
  </style>
</head>
<body>
  <div class="wrap">
    <h2>BLR Backend</h2>

    <div class="bar">
      <button class="btn" onclick="show('formCliente')">+ Nuevo cliente</button>
      <button class="btn" onclick="show('formPaquete')">+ Registrar paquete</button>
    </div>

    <!-- Form: Nuevo cliente -->
    <div id="formCliente" class="panel hidden">
      <h3>Nuevo cliente</h3>
      <div class="row">
        <div><label>Nombre</label><input id="cNombre" placeholder="Nombre completo"></div>
        <div><label>Teléfono</label><input id="cTel" placeholder="+1 ..."></div>
        <div><label>Email</label><input id="cEmail" placeholder="correo@ejemplo.com"></div>
        <div><label>Dirección</label><input id="cDir" placeholder="Calle, ciudad"></div>
      </div>
      <p><button class="btn" onclick="crearCliente()">Crear</button> <span id="cOut" class="muted"></span></p>
    </div>

    <!-- Form: Registrar paquete -->
    <div id="formPaquete" class="panel hidden">
      <h3>Registrar paquete recibido</h3>
      <div class="row">
        <div>
          <label>Cliente</label>
          <select id="selCliente"></select>
        </div>
        <div>
          <label>Peso (lb)</label>
          <input id="pPeso" type="number" step="0.01" min="0.01" placeholder="Ej: 1.85">
        </div>
      </div>
      <div style="margin-top:8px">
        <label>Nota (opcional)</label>
        <textarea id="pNota" rows="2" placeholder="Ej: Amazon #123-456..."></textarea>
      </div>
      <p><button class="btn" onclick="registrarPaquete()">Guardar paquete</button> <span id="pOut" class="muted"></span></p>
    </div>

    <!-- Listado simple de últimos paquetes (opcional) -->
    <div class="panel">
      <h3>Últimos paquetes</h3>
      <div id="tabla"></div>
    </div>
  </div>

  <script>
    const $ = sel => document.querySelector(sel);
    function show(id){
      ['formCliente','formPaquete'].forEach(x => $('#'+x).classList.add('hidden'));
      $('#'+id).classList.remove('hidden');
    }
    function notify(id,msg){ const el=$('#'+id); el.textContent = msg; setTimeout(()=>el.textContent='', 4000); }

    function loadClientes(){
      google.script.run.withSuccessHandler(list=>{
        const sel = $('#selCliente');
        sel.innerHTML = list.length
          ? list.map(c=>`<option value="${c.cliente_code}">${c.cliente_code} — ${c.nombre}</option>`).join('')
          : '<option value="">(Sin clientes)</option>';
      }).listarClientes();
    }

    function renderUltimos(){
      // Simple: reusar listar paquetes vía hoja (rápido y liviano)
      google.script.run.withSuccessHandler(json=>{
        const items = JSON.parse(json || '[]');
        const rows = items.slice(-10).reverse().map(r=>`
          <tr>
            <td>${r.pkg_code}</td>
            <td>${r.cliente_code}</td>
            <td>${r.peso_lb}</td>
            <td>${r.estado}</td>
            <td class="muted">${r.fecha_estado||r.fecha}</td>
          </tr>`).join('');
        $('#tabla').innerHTML = `<div style="overflow:auto">
          <table>
            <thead><tr><th>PKG</th><th>Cliente</th><th>Peso</th><th>Estado</th><th>Actualizado</th></tr></thead>
            <tbody>${rows || '<tr><td colspan="5" class="muted">Sin registros</td></tr>'}</tbody>
          </table></div>`;
      }).getAllPackagesJson?.(); // solo si existe; si no, no pasa nada
    }

    function crearCliente(){
      const n = $('#cNombre').value.trim();
      const t = $('#cTel').value.trim();
      const e = $('#cEmail').value.trim();
      const d = $('#cDir').value.trim();
      if(!n) { alert('Nombre requerido'); return; }
      google.script.run.withSuccessHandler(resp=>{
        if(resp.ok){
          notify('cOut','Creado: '+resp.cliente_code);
          $('#cNombre').value=''; $('#cTel').value=''; $('#cEmail').value=''; $('#cDir').value='';
          loadClientes(); show('formPaquete'); // directo a registrar paquete
        } else notify('cOut','Error: '+(resp.error||''));
      }).crearCliente(n,t,e,d);
    }

    function registrarPaquete(){
      const c = $('#selCliente').value;
      const w = parseFloat($('#pPeso').value);
      const note = $('#pNota').value.trim();
      if(!c){ alert('Selecciona cliente'); return; }
      if(isNaN(w) || w<=0){ alert('Peso inválido'); return; }
      google.script.run.withSuccessHandler(resp=>{
        if(resp.ok){
          notify('pOut','Guardado: '+resp.pkg_code);
          $('#pPeso').value=''; $('#pNota').value='';
          renderUltimos();
        } else notify('pOut','Error: '+(resp.error||''));
      }).registrarPaquete(c, w, note);
    }

    // Pequeño endpoint para la tabla: devuelve todo en JSON (lo definimos si no existe)
    if(typeof google !== 'undefined'){
      if(!google.script.run.getAllPackagesJson){
        google.script.run.getAllPackagesJson = function(){};
      }
    }

    document.addEventListener('DOMContentLoaded', ()=>{
      show('formPaquete');   // abre en “Registrar paquete” por defecto
      loadClientes();        // llena el selector de clientes
      renderUltimos();       // muestra últimos paquetes
    });
  </script>
  <?!= include('server_helpers'); ?>
</body>
</html>
