<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>BLR Admin (Online)</title>
  <style>
    body{font-family:system-ui,Arial;margin:0;background:#0d1117;color:#e6edf3}
    .wrap{max-width:960px;margin:auto;padding:20px}
    .bar{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:14px}
    .btn{cursor:pointer;border:1px solid #2d3a7b;background:linear-gradient(180deg,#2b47e5,#2038d0);color:#fff;padding:10px 14px;border-radius:10px;font-weight:700}
    .btn.secondary{background:#0f172a;border-color:#2b2f3a}
    .panel{background:#0f131a;border:1px solid #262a36;border-radius:14px;padding:16px;margin:12px 0}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    input,select,textarea{padding:10px;border-radius:10px;border:1px solid #2a2f3d;background:#0b0f16;color:#e6edf3;width:100%}
    label{font-size:12px;color:#9aa4ae}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px dashed #242838;text-align:left}
    .muted{color:#9aa4ae}
    .hidden{display:none}
    .right{display:flex;gap:8px;justify-content:flex-end}
  </style>
</head>
<body>
  <div class="wrap">
    <h2>BLR Admin (100% Online)</h2>

    <div class="bar">
      <button class="btn" onclick="show('formCliente')">+ Nuevo cliente</button>
      <button class="btn" onclick="show('formPaquete')">+ Registrar paquete</button>
      <span class="muted">Conectado a la API de Apps Script</span>
    </div>

    <!-- Form: Nuevo cliente -->
    <div id="formCliente" class="panel hidden">
      <h3>Nuevo cliente</h3>
      <div class="row">
        <div><label>Nombre</label><input id="cNombre" placeholder="Nombre completo"></div>
        <div><label>Teléfono</label><input id="cTel" placeholder="+1 ..."></div>
        <div><label>Email</label><input id="cEmail" placeholder="correo@ejemplo.com"></div>
        <div><label>Dirección</label><input id="cDir" placeholder="Calle, ciudad"></div>
      </div>
      <p class="right">
        <button class="btn" onclick="crearCliente()">Crear</button>
      </p>
      <p id="cOut" class="muted"></p>
    </div>

    <!-- Form: Registrar paquete -->
    <div id="formPaquete" class="panel hidden">
      <h3>Registrar paquete recibido</h3>
      <div class="row">
        <div>
          <label>Cliente</label>
          <select id="selCliente"></select>
        </div>
        <div>
          <label>Peso (lb)</label>
          <input id="pPeso" type="number" step="0.01" min="0.01" placeholder="Ej: 1.85">
        </div>
      </div>
      <div style="margin-top:8px">
        <label>Nota (opcional)</label>
        <textarea id="pNota" rows="2" placeholder="Ej: Amazon #123-456..."></textarea>
      </div>
      <p class="right">
        <button class="btn" onclick="registrarPaquete()">Guardar paquete</button>
      </p>
      <p id="pOut" class="muted"></p>
    </div>

    <div class="panel">
      <h3>Últimos paquetes</h3>
      <div id="tabla"></div>
      <p class="right">
        <button class="btn secondary" onclick="cargarPaquetes()">Actualizar</button>
      </p>
    </div>
  </div>

  <script>
    // ======= CONFIG =======
    // Pega aquí tu URL de Apps Script (termina en /exec) y tu API_KEY:
    const API_URL = 'https://script.google.com/macros/s/AKfycbzrgcAbOVvPBeNLMWE5Tn8iDC7ibmre5ahMGD6jrZwG4IEd8EdZhIQ44FtG7htdi8yl6A/exec';
    const API_KEY = 'REEMPLAZA_CON_TU_CLAVE_SECRETA';

    // ======= UTILS =======
    const $ = s => document.querySelector(s);
    const toQS = obj => new URLSearchParams(obj).toString();
    const notify = (id,msg) => { const el = $('#'+id); el.textContent = msg; setTimeout(()=> el.textContent='', 4000); };
    function show(id){ ['formCliente','formPaquete'].forEach(x=> $('#'+x).classList.add('hidden')); $('#'+id).classList.remove('hidden'); }

    // ======= API CALLS (sin preflight) =======
    async function apiGet(path, params={}){
      params.key = API_KEY;
      const url = `${API_URL}?${toQS({ path, ...params })}`;
      const r = await fetch(url, { method:'GET', headers:{ 'Accept':'application/json' } });
      return r.json();
    }
    async function apiPost(path, body={}){
      // Evitamos preflight con x-www-form-urlencoded
      body.key = API_KEY; body.path = path;
      const r = await fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type':'application/x-www-form-urlencoded' },
        body: toQS(body)
      });
      return r.json();
    }

    // ======= UI logic =======
    async function cargarClientes(){
      const res = await apiGet('api/clients');
      const sel = $('#selCliente');
      if (!res.ok || !res.clients?.length){
        sel.innerHTML = '<option value=\"\">(Sin clientes)</option>';
        return;
      }
      sel.innerHTML = res.clients.map(c => `<option value="${c.cliente_code}">${c.cliente_code} — ${c.nombre}</option>`).join('');
    }

    async function cargarPaquetes(){
      const res = await apiGet('api/packages', { limit: 20 });
      const items = res.ok ? (res.packages || []) : [];
      const rows = items.map(r=>`
        <tr>
          <td>${r.pkg_code}</td>
          <td>${r.cliente_code}</td>
          <td>${(r.peso_lb??0).toFixed ? r.peso_lb.toFixed(2) : r.peso_lb}</td>
          <td>${r.estado}</td>
          <td class="muted">${r.fecha_estado || r.fecha || ''}</td>
        </tr>`).join('');
      $('#tabla').innerHTML = `<div style="overflow:auto">
        <table>
          <thead><tr><th>PKG</th><th>Cliente</th><th>Peso</th><th>Estado</th><th>Actualizado</th></tr></thead>
          <tbody>${rows || '<tr><td colspan="5" class="muted">Sin registros</td></tr>'}</tbody>
        </table></div>`;
    }

    async function crearCliente(){
      const nombre = $('#cNombre').value.trim();
      const telefono = $('#cTel').value.trim();
      const email = $('#cEmail').value.trim();
      const direccion = $('#cDir').value.trim();
      if(!nombre){ alert('Nombre requerido'); return; }
      const res = await apiPost('api/clients/create', { nombre, telefono, email, direccion });
      if(res.ok){
        notify('cOut', 'Creado: '+res.cliente_code);
        $('#cNombre').value=''; $('#cTel').value=''; $('#cEmail').value=''; $('#cDir').value='';
        await cargarClientes();
        show('formPaquete');
      } else notify('cOut', 'Error: '+(res.error||''));
    }

    async function registrarPaquete(){
      const cliente_code = $('#selCliente').value;
      const peso_lb = parseFloat($('#pPeso').value);
      const nota = $('#pNota').value.trim();
      if(!cliente_code){ alert('Selecciona cliente'); return; }
      if(isNaN(peso_lb) || peso_lb<=0){ alert('Peso inválido'); return; }
      const res = await apiPost('api/packages/create', { cliente_code, peso_lb, nota });
      if(res.ok){
        notify('pOut','Guardado: '+res.pkg_code);
        $('#pPeso').value=''; $('#pNota').value='';
        cargarPaquetes();
      } else notify('pOut','Error: '+(res.error||'')); 
    }

    document.addEventListener('DOMContentLoaded', async ()=>{
      show('formPaquete');
      await cargarClientes();
      await cargarPaquetes();
    });
  </script>
</body>
</html>
